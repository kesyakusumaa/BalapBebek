<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Virtual Cockfighting Game - Enhanced Effects</title>
  <style>
    body { margin: 0; overflow: hidden; background: #222; }
    #ui {
      position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      z-index: 10; background: rgba(0,0,0,0.7); color: #fff; padding: 20px; border-radius: 10px;
      text-align: center;
    }
    .btn { margin: 10px; padding: 10px 20px; font-size: 18px; border: none; border-radius: 5px; cursor: pointer;}
    .btn-blue { background: #2980f2; color: #fff; }
    .btn-red { background: #e74c3c; color: #fff; }
    .health-bar {
      width: 120px; height: 18px; background: #444; border-radius: 8px; overflow: hidden;
      margin: 8px auto;
      box-shadow: 0 0 6px #000;
      position: relative;
    }
    .health-fill {
      height: 100%; border-radius: 8px;
      transition: width 0.4s, background 0.2s;
    }
    .flash { animation: flash 0.3s; }
    @keyframes flash {
      0% { background: #ff0000; }
      100% { background: inherit; }
    }
    #result {
      font-size: 2em; color: yellow; margin-top: 20px;
      text-shadow: 2px 2px 8px #000;
    }
  </style>
</head>
<body>
<div id="ui">
  <div id="choose">
    <h2>Choose Your Chicken</h2>
    <button class="btn btn-blue" onclick="selectChicken('blue')">Blue Chicken</button>
    <button class="btn btn-red" onclick="selectChicken('red')">Red Chicken</button>
  </div>
  <div id="fightui" style="display:none;">
    <div>
      <span>Blue Chicken</span>
      <div class="health-bar"><div class="health-fill" id="blueHealth" style="background:#2980f2;width:100%"></div></div>
    </div>
    <div>
      <span>Red Chicken</span>
      <div class="health-bar"><div class="health-fill" id="redHealth" style="background:#e74c3c;width:100%"></div></div>
    </div>
    <div id="result"></div>
  </div>
</div>
<canvas id="game"></canvas>
<script src="https://unpkg.com/three@0.148.0/build/three.min.js"></script>
<script>
let selected = null, fighting = false;
let blueHealth = 100, redHealth = 100;
let blueObj, redObj, scene, camera, renderer, animID;
const canvas = document.getElementById('game');
let shakeTimeout = null;

function selectChicken(color) {
  selected = color;
  document.getElementById('choose').style.display = 'none';
  document.getElementById('fightui').style.display = '';
  startGame();
}

function startGame() {
  // 3D Scene setup
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 3, 10);
  renderer = new THREE.WebGLRenderer({canvas, antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);

  // Arena
  const floor = new THREE.Mesh(
    new THREE.CircleGeometry(6, 32),
    new THREE.MeshStandardMaterial({color:0xaaaa88, roughness:0.7})
  );
  floor.rotation.x = -Math.PI/2;
  scene.add(floor);

  // Lighting
  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5,10,7);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x999999));

  // Chickens (replace with models if available)
  const blueMat = new THREE.MeshStandardMaterial({color:0x2980f2});
  const redMat = new THREE.MeshStandardMaterial({color:0xe74c3c});

  blueObj = new THREE.Mesh(new THREE.BoxGeometry(1,1.5,1), blueMat);
  blueObj.position.set(-2,0.75,0);

  const blueScarf = new THREE.Mesh(new THREE.TorusGeometry(0.55,0.12,16,32), 
    new THREE.MeshStandardMaterial({color:0x0a5eea}));
  blueScarf.position.set(0,0.7,0);
  blueScarf.rotation.x = Math.PI/2;
  blueObj.add(blueScarf);

  redObj = new THREE.Mesh(new THREE.BoxGeometry(1,1.5,1), redMat);
  redObj.position.set(2,0.75,0);

  const redScarf = new THREE.Mesh(new THREE.TorusGeometry(0.55,0.12,16,32), 
    new THREE.MeshStandardMaterial({color:0xc21818}));
  redScarf.position.set(0,0.7,0);
  redScarf.rotation.x = Math.PI/2;
  redObj.add(redScarf);

  scene.add(blueObj); scene.add(redObj);

  fighting = true;
  blueHealth = 100; redHealth = 100;
  updateHealth();
  animate();
  setTimeout(fightTurn, 1200);
}

function animate() {
  animID = requestAnimationFrame(animate);
  blueObj.rotation.y += 0.01;
  redObj.rotation.y -= 0.01;
  renderer.render(scene, camera);
}

function fightTurn() {
  if (!fighting) return;
  let attacker, defender, attackerObj, defenderObj;
  if (Math.random() > 0.5) {
    attacker = 'blue'; defender = 'red';
    attackerObj = blueObj; defenderObj = redObj;
  } else {
    attacker = 'red'; defender = 'blue';
    attackerObj = redObj; defenderObj = blueObj;
  }

  let origZ = attackerObj.position.z;
  let origY = attackerObj.position.y;
  // Lunge and shake
  attackerObj.position.z -= 0.7;
  shakeObject(attackerObj, 100, 0.15);
  setTimeout(()=>{
    attackerObj.position.z = origZ;
    // Damage
    let dmg = Math.floor(Math.random()*20+15);
    if (defender === 'red') redHealth -= dmg;
    else blueHealth -= dmg;
    showBlood(defenderObj, dmg, true);
    updateHealth(defender);

    // Health bar flash
    let healthBarId = defender === 'red' ? 'redHealth' : 'blueHealth';
    let bar = document.getElementById(healthBarId);
    bar.classList.add('flash');
    setTimeout(()=>bar.classList.remove('flash'), 300);

    // Screen shake effect
    screenShake(200, 10);

    // Dramatic death if health below zero
    checkWinner();
    if (fighting) setTimeout(fightTurn, 900);
  }, 340);
}

function shakeObject(obj, duration, magnitude) {
  let time = 0;
  let shakeInt = setInterval(() => {
    obj.position.x += (Math.random()-0.5)*magnitude;
    obj.position.y += (Math.random()-0.5)*magnitude;
    time += 20;
    if (time >= duration) {
      obj.position.x = Math.round(obj.position.x);
      obj.position.y = Math.round(obj.position.y);
      clearInterval(shakeInt);
    }
  }, 20);
}

function screenShake(duration, magnitude) {
  let time = 0;
  let origStyle = canvas.style.transform;
  if (shakeTimeout) clearTimeout(shakeTimeout);
  let shakeInt = setInterval(() => {
    canvas.style.transform = `translate(${(Math.random()-0.5)*magnitude}px, ${(Math.random()-0.5)*magnitude}px)`;
    time += 20;
    if (time >= duration) {
      clearInterval(shakeInt);
      canvas.style.transform = origStyle;
    }
  }, 20);
  shakeTimeout = setTimeout(()=>{canvas.style.transform = origStyle;}, duration+20);
}

function showBlood(obj, amount, splatter) {
  for (let i=0; i<Math.floor(amount/10); i++) {
    const blood = new THREE.Mesh(
      new THREE.SphereGeometry(0.07, 8, 8),
      new THREE.MeshStandardMaterial({color:0xb80000, roughness:0.7, transparent:true, opacity:0.8})
    );
    blood.position.copy(obj.position);
    blood.position.x += (Math.random()-0.5)*0.6;
    blood.position.y += (Math.random())*1.1;
    blood.position.z += (Math.random()-0.5)*0.2;
    scene.add(blood);
    setTimeout(()=>scene.remove(blood), 1200);
    // Splatter effect: "throw" blood up
    if (splatter) {
      let upward = (Math.random()*0.5)+0.2;
      let bloodInt = setInterval(()=> {
        blood.position.y += upward;
        upward -= 0.05;
        if (upward <= 0) clearInterval(bloodInt);
      }, 60);
    }
  }
}

function updateHealth(damaged) {
  document.getElementById('blueHealth').style.width = Math.max(0, blueHealth) + '%';
  document.getElementById('redHealth').style.width = Math.max(0, redHealth) + '%';
}

function checkWinner() {
  if (redHealth <= 0 || blueHealth <= 0) {
    fighting = false;
    cancelAnimationFrame(animID);
    let winner, loserObj, winnerObj;
    if (redHealth > blueHealth) {
      winner = "Red Chicken Wins!";
      loserObj = blueObj; winnerObj = redObj;
    } else if (blueHealth > redHealth) {
      winner = "Blue Chicken Wins!";
      loserObj = redObj; winnerObj = blueObj;
    } else {
      winner = "It's a Draw!";
    }
    document.getElementById('result').innerText = winner;
    // Death effect
    if (loserObj) chickenDeath(loserObj);
    if (winnerObj) chickenVictory(winnerObj);
    setTimeout(()=>location.reload(), 4000); // restart game
  }
}

function chickenDeath(obj) {
  // Rotate and fade
  let rot = 0;
  let fade = 1;
  let deathInt = setInterval(()=>{
    rot += 0.08;
    obj.rotation.z = rot;
    fade -= 0.04;
    obj.material.opacity = Math.max(fade, 0);
    obj.material.transparent = true;
    if (fade <= 0) {
      clearInterval(deathInt);
      obj.visible = false;
    }
  }, 60);
}

function chickenVictory(obj) {
  // Victory dance: bounce up and down
  let up = true;
  let danceCount = 0;
  let origY = obj.position.y;
  let danceInt = setInterval(()=>{
    if (up) obj.position.y += 0.15;
    else obj.position.y -= 0.15;
    up = !up;
    danceCount++;
    if (danceCount > 8) {
      obj.position.y = origY;
      clearInterval(danceInt);
    }
  }, 120);
}

// Responsive canvas
window.addEventListener('resize', ()=>{
  if (renderer && camera) {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
});
</script>
</body>
</html>
